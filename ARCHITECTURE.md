# ğŸ—ï¸ Crypto Payment Architecture

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚   Pricing    â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚   Checkout   â”‚                     â”‚
â”‚  â”‚     Page     â”‚         â”‚     Page     â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                  â”‚                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                    â”‚                           â”‚               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚              â”‚  ğŸ’³ Card  â”‚             â”‚  â‚¿ Crypto   â”‚         â”‚
â”‚              â”‚  Payment  â”‚             â”‚   Payment   â”‚         â”‚
â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                    â”‚                          â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                          â”‚
                     â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     STRIPE INTEGRATION        â”‚  â”‚  COINBASE INTEGRATION      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               â”‚  â”‚                            â”‚
â”‚  POST /api/stripe/           â”‚  â”‚  POST /api/coinbase/       â”‚
â”‚    create-checkout-session   â”‚  â”‚    create-charge           â”‚
â”‚                               â”‚  â”‚                            â”‚
â”‚  - Validate user              â”‚  â”‚  - Validate user           â”‚
â”‚  - Create session             â”‚  â”‚  - Create charge           â”‚
â”‚  - Return checkout URL        â”‚  â”‚  - Return hosted URL       â”‚
â”‚                               â”‚  â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â”‚                               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Stripe.com     â”‚            â”‚  Coinbase.com   â”‚
       â”‚  Checkout Page  â”‚            â”‚  Commerce Page  â”‚
       â”‚                 â”‚            â”‚                 â”‚
       â”‚  [Card Input]   â”‚            â”‚  [Crypto Select]â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â”‚ (User pays)                   â”‚ (User pays)
                â”‚                               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Stripe Server  â”‚            â”‚ Coinbase Server â”‚
       â”‚  (Processing)   â”‚            â”‚  (Blockchain)   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â”‚ Webhook Event                 â”‚ Webhook Event
                â”‚                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/stripe/webhook     â”‚  â”‚ POST /api/coinbase/webhook â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               â”‚  â”‚                            â”‚
â”‚  - Verify signature           â”‚  â”‚  - Verify signature        â”‚
â”‚  - Check duplicates           â”‚  â”‚  - Check duplicates        â”‚
â”‚  - Credit tokens              â”‚  â”‚  - Credit tokens           â”‚
â”‚  - Create payment record      â”‚  â”‚  - Create payment record   â”‚
â”‚  - Create ledger entry        â”‚  â”‚  - Create ledger entry     â”‚
â”‚                               â”‚  â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    DATABASE LAYER      â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Wallet Table    â”‚  â”‚
                    â”‚  â”‚  - userId        â”‚  â”‚
                    â”‚  â”‚  - balance       â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  Payment Table   â”‚  â”‚
                    â”‚  â”‚  - provider      â”‚  â”‚
                    â”‚  â”‚  - providerRef   â”‚  â”‚
                    â”‚  â”‚  - status        â”‚  â”‚
                    â”‚  â”‚  - credits       â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                        â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  LedgerEntry     â”‚  â”‚
                    â”‚  â”‚  - type          â”‚  â”‚
                    â”‚  â”‚  - amount        â”‚  â”‚
                    â”‚  â”‚  - balanceAfter  â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Payment Flow Sequence

### ğŸ’³ Credit Card Flow (Stripe)

```
User                    App                      Stripe              Database
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 1. Select Plan       â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 2. Choose "Card"     â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚ 3. Create Session       â”‚                    â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚ 4. Return URL           â”‚                    â”‚
 â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 5. Redirect          â”‚                         â”‚                    â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 6. Enter Card & Pay  â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚ 7. Process Payment â”‚
 â”‚                       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚ 8. Webhook Event        â”‚                    â”‚
 â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚ 9. Update Wallet   â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚ 10. Create Payment â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 11. Redirect Success â”‚                         â”‚                    â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 12. View Tokens      â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
```

â±ï¸ **Time:** ~1-2 minutes (instant payment)

---

### â‚¿ Cryptocurrency Flow (Coinbase)

```
User                    App                   Coinbase              Database
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 1. Select Plan       â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 2. Choose "Crypto"   â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚ 3. Create Charge        â”‚                    â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚ 4. Return Hosted URL    â”‚                    â”‚
 â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 5. Redirect          â”‚                         â”‚                    â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 6. Select Crypto     â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 7. Send Payment      â”‚                         â”‚                    â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚ 8. Monitor Chain   â”‚
 â”‚                       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                         â”‚   (10-30 mins)     â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚ 9. Webhook: confirmed   â”‚                    â”‚
 â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚ 10. Update Wallet  â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚ 11. Create Payment â”‚
 â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 12. Redirect Success â”‚                         â”‚                    â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
 â”‚ 13. View Tokens      â”‚                         â”‚                    â”‚
 â”‚                       â”‚                         â”‚                    â”‚
```

â±ï¸ **Time:** ~15-35 minutes (blockchain confirmation)

---

## Data Flow

### Payment Record Creation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WEBHOOK RECEIVED                   â”‚
â”‚  - Event type (charge:confirmed)                â”‚
â”‚  - Charge data (user, amount, etc.)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Verify signature
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   VALIDATION    â”‚
         â”‚  - Check user   â”‚
         â”‚  - Check plan   â”‚
         â”‚  - Check tokens â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Pass
                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  CHECK DUPLICATES     â”‚
      â”‚  Query Payment table  â”‚
      â”‚  by providerRef       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Not exists
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  UPDATE WALLET            â”‚
    â”‚  Balance += tokens        â”‚
    â”‚  (atomic increment)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CREATE PAYMENT RECORD    â”‚
    â”‚  - provider: COINBASE     â”‚
    â”‚  - status: SUCCEEDED      â”‚
    â”‚  - credits: tokens        â”‚
    â”‚  - webhookData: full JSON â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CREATE LEDGER ENTRY      â”‚
    â”‚  - type: DEPOSIT          â”‚
    â”‚  - amount: tokens         â”‚
    â”‚  - balanceAfter: new bal  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   COMPLETE âœ…   â”‚
         â”‚  Return 200 OK  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY LAYERS                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  Layer 1: User Authentication                  â”‚
â”‚  â”œâ”€ NextAuth.js session validation            â”‚
â”‚  â””â”€ Requires logged-in user                   â”‚
â”‚                                                â”‚
â”‚  Layer 2: HTTPS Encryption (Production)        â”‚
â”‚  â”œâ”€ All API calls over HTTPS                  â”‚
â”‚  â””â”€ Webhook endpoints secured                 â”‚
â”‚                                                â”‚
â”‚  Layer 3: Webhook Signature Verification       â”‚
â”‚  â”œâ”€ HMAC-SHA256 signature check               â”‚
â”‚  â””â”€ Rejects unauthorized requests             â”‚
â”‚                                                â”‚
â”‚  Layer 4: Data Validation                      â”‚
â”‚  â”œâ”€ Server-side input validation              â”‚
â”‚  â””â”€ Type checking with TypeScript             â”‚
â”‚                                                â”‚
â”‚  Layer 5: Duplicate Prevention                 â”‚
â”‚  â”œâ”€ Check providerRef uniqueness              â”‚
â”‚  â””â”€ Skip if payment already processed         â”‚
â”‚                                                â”‚
â”‚  Layer 6: Transaction Atomicity                â”‚
â”‚  â”œâ”€ Database transactions                     â”‚
â”‚  â””â”€ Rollback on errors                        â”‚
â”‚                                                â”‚
â”‚  Layer 7: Audit Trail                          â”‚
â”‚  â”œâ”€ Complete webhook data stored              â”‚
â”‚  â”œâ”€ Ledger entry for every transaction        â”‚
â”‚  â””â”€ Timestamp all records                     â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Database Schema Relations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Wallet  â”‚<â”€â”€â”€â”€â”€â”€â”€>â”‚ LedgerEntry  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚
     â”‚                    â”‚
     â”‚               â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
     â”‚               â”‚  Balance  â”‚
     â”‚               â”‚  (Tokens) â”‚
     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ Payment  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id       â”‚ (Primary key)
â”‚ userId   â”‚ (Foreign key â†’ User)
â”‚ provider â”‚ (STRIPE | COINBASE)
â”‚ status   â”‚ (PENDING | SUCCEEDED | FAILED)
â”‚ amount   â”‚ (USD value)
â”‚ credits  â”‚ (Tokens)
â”‚ webhookData â”‚ (Full JSON)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Environment Variables Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ENVIRONMENT VARIABLES              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  Payment Providers:                        â”‚
â”‚  â”œâ”€ STRIPE_SECRET_KEY                      â”‚
â”‚  â”œâ”€ STRIPE_WEBHOOK_SECRET                  â”‚
â”‚  â”œâ”€ COINBASE_COMMERCE_API_KEY              â”‚
â”‚  â””â”€ COINBASE_COMMERCE_WEBHOOK_SECRET       â”‚
â”‚                                            â”‚
â”‚  Application:                              â”‚
â”‚  â”œâ”€ NEXT_PUBLIC_APP_URL                    â”‚
â”‚  â”œâ”€ DATABASE_URL                           â”‚
â”‚  â””â”€ AUTH_SECRET                            â”‚
â”‚                                            â”‚
â”‚  External Services:                        â”‚
â”‚  â”œâ”€ LIVEKIT_URL                            â”‚
â”‚  â”œâ”€ LIVEKIT_API_KEY                        â”‚
â”‚  â””â”€ REDIS_URL                              â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Organization

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ stripe/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-checkout-session/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts           [Stripe: Create session]
â”‚   â”‚   â”‚   â””â”€â”€ webhook/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts           [Stripe: Handle webhooks]
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ coinbase/
â”‚   â”‚       â”œâ”€â”€ create-charge/
â”‚   â”‚       â”‚   â””â”€â”€ route.ts           [Coinbase: Create charge]
â”‚   â”‚       â””â”€â”€ webhook/
â”‚   â”‚           â””â”€â”€ route.ts           [Coinbase: Handle webhooks]
â”‚   â”‚
â”‚   â”œâ”€â”€ checkout/
â”‚   â”‚   â””â”€â”€ page.tsx                   [Checkout page with dual payment]
â”‚   â”‚
â”‚   â””â”€â”€ pricing/
â”‚       â””â”€â”€ page.tsx                   [Token pricing page]
â”‚
â””â”€â”€ components/
    â””â”€â”€ pricing/
        â”œâ”€â”€ crypto-payment-dialog.tsx  [Crypto payment modal]
        â””â”€â”€ viewer-token-page.tsx      [Token packages display]
```

---

## API Endpoint Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API ENDPOINTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  POST /api/stripe/create-checkout-session                  â”‚
â”‚  â”œâ”€ Input: { planId: string }                              â”‚
â”‚  â””â”€ Output: { sessionId, url }                             â”‚
â”‚                                                             â”‚
â”‚  POST /api/stripe/webhook                                   â”‚
â”‚  â”œâ”€ Input: Stripe event (signature header)                 â”‚
â”‚  â””â”€ Output: { received: true }                             â”‚
â”‚                                                             â”‚
â”‚  POST /api/coinbase/create-charge                          â”‚
â”‚  â”œâ”€ Input: { planId: string }                              â”‚
â”‚  â””â”€ Output: { chargeId, chargeCode, hostedUrl, expiresAt } â”‚
â”‚                                                             â”‚
â”‚  POST /api/coinbase/webhook                                 â”‚
â”‚  â”œâ”€ Input: Coinbase event (signature header)               â”‚
â”‚  â””â”€ Output: { received: true }                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Success Metrics Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PAYMENT METRICS                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  Total Payments:                               â”‚
â”‚  â”œâ”€ Card (Stripe):      XXX (XX%)              â”‚
â”‚  â””â”€ Crypto (Coinbase):  XXX (XX%)              â”‚
â”‚                                                â”‚
â”‚  Revenue:                                      â”‚
â”‚  â”œâ”€ Card:   $X,XXX (Net: $X,XXX)               â”‚
â”‚  â””â”€ Crypto: $X,XXX (Net: $X,XXX)               â”‚
â”‚                                                â”‚
â”‚  Conversion Rate:                              â”‚
â”‚  â”œâ”€ Card:   XX%                                â”‚
â”‚  â””â”€ Crypto: XX%                                â”‚
â”‚                                                â”‚
â”‚  Average Transaction:                          â”‚
â”‚  â”œâ”€ Card:   $XX.XX                             â”‚
â”‚  â””â”€ Crypto: $XX.XX                             â”‚
â”‚                                                â”‚
â”‚  Failed Payments:                              â”‚
â”‚  â”œâ”€ Card:   X (X%)                             â”‚
â”‚  â””â”€ Crypto: X (X%)                             â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**This architecture is production-ready and scalable! ğŸš€**
